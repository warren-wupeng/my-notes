# 202205160949 event or command?

DDD的命令与事件是容易混淆的概念，在建模的时候我们往往难以判断应该建模成命令还是事件。

先来看看事件与命令概念上的区别。

事件（event）代表一种已经发生无法被销毁的事实。

命令（command) 代表一种对未来的期望，它可能被拒绝。

事件通常有多个消费方，而命令通常只有一个消费方

但是这个概念仍然很难指导我们去判断什么时候应该用事件什么时候应该用命令

首先命令触发意味着调用房必须理解和处理被调用方的各种响应情况，被调用方的失败会影响调用方，是一种更深度的耦合。而事件驱动方式，事件生产方不需要关心消费方的处理结果，是一种更松的耦合，所以能够避免命令方式是尽量要避免的。
但是命令方式是不能完全避免，因为总要有程序对用户的请求结果端到端负责。


命令适合高层抽象对底层实现层的通信。因为高层抽象要负责用户目标的达成，一种技术实现失败时，高层可能会采取重试或者降级等策略去尽量完成用户目标，就算最终失败时也会给用户适当的反馈。
事件适合同级抽象层之间的通信。这样就可以减少不同模块之间的耦合。当然一般是指跨聚合根的模块之间的通信。

举例来说，服务端对客户端来说就是一种技术实现。客户端可以按某种策略在多种服务端之间切换实现。举个极端的例子，后端订单服务无响应时，客户端可以调用客服服务创建一个服务工单，让客服团队手工为用户创建订单。所以服务端面向客户端的写操作接口应该建模为一种命令。

而后端内部服务之间分成两种情况。

一种是业务服务之间的通信，应该尽量用事件方式，例如trickle模块和notification模块之间的通信,因为负责创建trickle的模块不需要理解用户接收通知的偏好。

另一种是业务层服务和技术层服务之间的通信，适合用命令方式，例如，notification模块和email模块之间。notification模块和email模块之间是一种意图与实现之间的关系，notification的目标是让通知送达用户，至于采用短信还是email还是用哪个email服务提供商，这些写都是技术实现，多种实现的协调策略需要在notification层管控。

例如考虑下面这个问题,订单模块和支付模块，订单下单后需要触发支付
一种方式是订单服务发布“已下单”事件，支付服务消费这个事件。
另一种方式是订单服务向支付服务发出“收款“的命令。

```
Order -[OrderPlaced]-> Payment

Order -[CollectPayment] -> Payment
```
乍一看两种方式似乎都可以，但是其实不然。
在命令触发方式中隐含一种假设，订单模块需要负责管理和协调支付服务。
而在事件驱动方式中，订单模块不需要关心支付的成败
订单模块需要理解支付模块的各种可能的返回结果，并做出相应处理。
换句话说就是订单模块必须理解支付模块的细节，支付相关的细节或多或少会泄漏到订单模块，造成两个模块的耦合。
假设订单模块和支付模块是同一服务并且是同一个团队维护那么两只方式差别并不大，但是如果订单和支付已经拆成两个独立的服务，或者说在未来可能会拆分成两个服务，那么事件驱动的方式会更好